import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from io import StringIO

# ==================== ä¸­æ–‡å­—é«”è¨­å®šï¼ˆé¿å…äº‚ç¢¼ï¼‰ ====================
plt.rcParams['font.sans-serif'] = [
    'Taipei Sans TC Beta', 'Microsoft JhengHei', 'SimHei', 'Arial Unicode MS'
]
plt.rcParams['axes.unicode_minus'] = False

# ==================== é é¢æ¨™é¡Œ ====================
st.title("ğŸŒ¤ï¸ å°ä¸­å¸‚ å¤šè¦ç´ åˆ†æå„€è¡¨æ¿")
st.markdown("### 2025å¹´10æœˆï½11æœˆ çœŸå¯¦æ°£è±¡è³‡æ–™åˆ†æ")

# ==================== åŸå§‹è³‡æ–™ ====================
data = """467490, 20251001, 28.8, 0.0, 8.1, 7.32, 110000
467490, 20251002, 28.9, 0.0, 8.0, 8.26, 110000
467490, 20251003, 28.9, 0.0, 7.4, 8.01, 110000
467490, 20251004, 29.4, 0.0, 9.3, 9.22, 130000
467490, 20251005, 29.3, 0.0, 8.7, 8.32, 110000
467490, 20251006, 29.2, 0.0, 7.2, 7.74, 120000
467490, 20251007, 29.5, 0.0, 6.6, 6.87, 120000
467490, 20251008, 29.6, 0.0, 5.1, 5.74, 110000
467490, 20251009, 29.2, 0.0, 3.3, 6.34, 130000
467490, 20251010, 29.0, 0.0, 7.1, 8.11, 120000
467490, 20251011, 29.3, 0.0, 9.4, 8.90, 120000
467490, 20251012, 28.5, 0.0, 9.2, 7.93, 120000
467490, 20251013, 28.9, 0.0, 8.9, 7.04, 110000
467490, 20251014, 29.2, 0.0, 9.7, 8.87, 120000
467490, 20251015, 28.9, 0.0, 5.2, 7.01, 120000
467490, 20251016, 28.7, 0.0, 5.8, 4.68, 130000
467490, 20251017, 29.1, 0.0, 8.3, 8.00, 120000
467490, 20251018, 29.2, 0.0, 9.3, 6.47, 120000
467490, 20251019, 28.4, 0.0, 3.0, 4.89, 130000
467490, 20251020, 27.0, 1.5, 3.3, 10.30, 120000
467490, 20251021, 25.4, 0.0, 5.6, 9.73, 120000
467490, 20251022, 25.1, 0.0, 5.3, 9.81, 120000
467490, 20251023, 26.2, -9.8, 1.2, 6.57, 120000
467490, 20251024, 26.1, 0.0, 3.7, 8.86, 120000
467490, 20251025, 26.6, 0.0, 8.5, 8.18, 120000
467490, 20251026, 25.9, 0.0, 9.9, 8.41, 120000
467490, 20251027, 24.4, 0.5, 0.2, 4.84, 120000
467490, 20251028, 22.9, 5.0, 0.0, 4.15, 130000
467490, 20251029, 25.3, -9.8, 8.2, 7.72, 120000
467490, 20251030, 26.4, 0.0, 2.7, 4.58, 110000
467490, 20251031, 25.4, 0.0, 9.1, 7.65, 120000
467490, 20251101, 25.1, 0.0, 3.8, 5.35, 140000
467490, 20251102, 24.3, 0.0, 0.9, 4.52, 140000
467490, 20251103, 23.8, 0.0, 3.8, 7.45, 130000
467490, 20251104, 24.0, 0.0, 4.6, 6.95, 120000
467490, 20251105, 25.4, 0.0, 9.9, 8.17, 120000
467490, 20251106, 26.1, 0.0, 9.7, 7.26, 120000
467490, 20251107, 27.1, 0.0, 9.8, 7.06, 120000
467490, 20251108, 26.2, 0.0, 2.8, 5.51, 130000
467490, 20251109, 26.4, 0.0, 6.3, 6.89, 120000
467490, 20251110, 25.2, -9.8, 0.9, 4.34, 110000
467490, 20251111, 25.3, -9.8, 2.5, 5.21, 130000
467490, 20251112, 24.1, 0.5, 0.0, 4.17, 140000
467490, 20251113, 24.0, 1.5, 2.5, 5.44, 110000
467490, 20251114, 23.8, -9.8, 9.8, 7.31, 120000
467490, 20251115, 24.0, 0.0, 9.8, 6.94, 120000
467490, 20251116, 24.1, 0.0, 9.8, 7.03, 120000
467490, 20251117, 24.1, 0.0, 9.7, 7.17, 120000
467490, 20251118, 20.9, 0.0, 4.3, 6.61, 120000
467490, 20251119, 17.3, -9.8, 0.1, 2.74, 120000
467490, 20251120, 19.2, 0.0, 5.1, 6.53, 120000
467490, 20251121, 20.8, -9.8, 1.9, 4.05, 120000
467490, 20251122, 21.3, 0.0, 9.9, 6.01, 120000
467490, 20251123, 22.0, 0.0, 10.0, 6.30, 120000
467490, 20251124, 22.8, 0.0, 9.5, 5.65, 120000
467490, 20251125, 21.3, 0.0, 9.5, 5.91, 120000
467490, 20251126, 20.2, 0.0, 7.7, 5.62, 120000
467490, 20251127, 20.3, -9.8, 2.0, 3.68, 140000
467490, 20251128, 20.3, -9.8, 0.8, 4.30, 110000
467490, 20251129, 20.9, 0.0, 9.3, 5.80, 120000
467490, 20251130, 22.0, 0.0, 4.2, 6.06, 120000
"""

# ==================== è®€å–è³‡æ–™ ====================
df = pd.read_csv(
    StringIO(data),
    header=None,
    names=['stno', 'yyyymmdd', 'TX01', 'PP01', 'SS01', 'UV01', 'UV03'],
    skipinitialspace=True
)

# -9.8 ç‚ºé›¨è·¡ï¼ˆTrace rainï¼‰ï¼Œæ­¤åˆ†æè¦–ç‚º 0 mm
df['PP01'] = df['PP01'].replace(-9.8, 0.0)

df['date'] = pd.to_datetime(df['yyyymmdd'], format='%Y%m%d')
df = df.sort_values('date').reset_index(drop=True)
df['month'] = df['date'].dt.month
# ==================== å¤ªé™½èƒ½ç™¼é›»æ½›åŠ›ä¼°ç®— ====================
panel_area = 10          # mÂ²
panel_efficiency = 0.18  # 18%
solar_irradiance = 1.0   # kW/mÂ²ï¼ˆç°¡åŒ–å‡è¨­ï¼‰

# UV æ­£è¦åŒ–ï¼ˆé¿å…æ•¸å€¼éå¤§ï¼‰
df['UV_norm'] = df['UV01'] / df['UV01'].max()

# é ä¼°æ¯æ—¥ç™¼é›»é‡ï¼ˆkWhï¼‰
df['solar_kwh'] = (
    df['SS01'] *
    solar_irradiance *
    panel_area *
    panel_efficiency *
    df['UV_norm']
)



# ==================== å´é‚Šæ¬„ ====================
st.sidebar.header("âš™ï¸ åˆ†æè¨­å®š")

primary = st.sidebar.selectbox(
    "ä¸»è¦é¡¯ç¤ºè¦ç´ ",
    ['TX01', 'PP01', 'SS01', 'UV01'],
    format_func=lambda x: {
        'TX01':'å¹³å‡æ°£æº«(â„ƒ)',
        'PP01':'é™æ°´é‡(mm)',
        'SS01':'æ—¥ç…§æ™‚æ•¸(å°æ™‚)',
        'UV01':'ç´«å¤–ç·šæŒ‡æ•¸'
    }[x]
)

def format_secondary(x):
    if x is None:
        return 'ç„¡'
    return {
        'TX01':'å¹³å‡æ°£æº«(â„ƒ)',
        'PP01':'é™æ°´é‡(mm)',
        'SS01':'æ—¥ç…§æ™‚æ•¸(å°æ™‚)',
        'UV01':'ç´«å¤–ç·šæŒ‡æ•¸'
    }[x]

secondary = st.sidebar.selectbox(
    "ç¬¬äºŒè¦ç´ ï¼ˆé›™Yè»¸æ¯”è¼ƒï¼Œå¯é¸ç„¡ï¼‰",
    [None, 'TX01', 'PP01', 'SS01', 'UV01'],
    format_func=format_secondary
)

window = st.sidebar.slider("ç§»å‹•å¹³å‡å¤©æ•¸", 1, 30, 7)

# ==================== çµ±è¨ˆ ====================
col_name = {'TX01':'å¹³å‡æ°£æº«', 'PP01':'é™æ°´é‡', 'SS01':'æ—¥ç…§æ™‚æ•¸', 'UV01':'ç´«å¤–ç·šæŒ‡æ•¸'}
unit = {'TX01':'â„ƒ', 'PP01':'mm', 'SS01':'å°æ™‚', 'UV01':''}

avg = df[primary].mean()
total = df[primary].sum()
max_val = df[primary].max()

# â­ é—œéµä¿®æ­£ï¼šæ—¥æœŸä¸€å®šè½‰æˆå­—ä¸²
if df[primary].notna().any():
    max_day = df.loc[df[primary].idxmax(), 'date'].strftime('%Y-%m-%d')
else:
    max_day = "ç„¡è³‡æ–™"

# ==================== é¡¯ç¤ºæŒ‡æ¨™ ====================
st.subheader(f"ğŸ“Š {col_name[primary]} çµ±è¨ˆ")
c1, c2, c3, c4 = st.columns(4)

c1.metric("å¹³å‡å€¼", f"{avg:.2f} {unit[primary]}")
c2.metric("ç¸½å’Œ", f"{total:.1f} {unit[primary]}")
c3.metric("æœ€å¤§å€¼", f"{max_val:.2f} {unit[primary]}")
c4.metric("æœ€å¤§å€¼æ—¥æœŸ", max_day)

# ==================== è¶¨å‹¢åœ– ====================
st.subheader("ğŸ“ˆ æ¯æ—¥è¶¨å‹¢åœ–ï¼ˆå«ç§»å‹•å¹³å‡ï¼‰")
fig, ax1 = plt.subplots(figsize=(12, 6))

ax1.plot(df['date'], df[primary], alpha=0.6, label=col_name[primary])
ax1.plot(
    df['date'],
    df[primary].rolling(window=window).mean(),
    linewidth=3,
    label=f'{window} å¤©ç§»å‹•å¹³å‡'
)

if secondary:
    ax2 = ax1.twinx()
    ax2.plot(df['date'], df[secondary], alpha=0.6, label=col_name[secondary])
    ax2.plot(
        df['date'],
        df[secondary].rolling(window=window).mean(),
        linewidth=3,
        label=f'{window} å¤©ç§»å‹•å¹³å‡'
    )

lines1, labels1 = ax1.get_legend_handles_labels()
if secondary:
    lines2, labels2 = ax2.get_legend_handles_labels()
    ax1.legend(lines1 + lines2, labels1 + labels2)
else:
    ax1.legend()

ax1.set_xlabel("æ—¥æœŸ")
ax1.grid(alpha=0.3)
st.pyplot(fig)

# ==================== è³‡æ–™è¡¨ ====================
with st.expander("ğŸ” æŸ¥çœ‹å®Œæ•´åŸå§‹è³‡æ–™"):
    st.dataframe(df[['date','TX01','PP01','SS01','UV01']])

# ==================== 10 æœˆ vs 11 æœˆæ¯”è¼ƒ ====================
st.subheader("ğŸ“… 10 æœˆ vs 11 æœˆæ¯”è¼ƒ")

month_map = {10: "10 æœˆ", 11: "11 æœˆ"}

compare_df = (
    df[df['month'].isin([10, 11])]
    .groupby('month')[primary]
    .agg(['mean', 'sum', 'max'])
    .rename(index=month_map)
)

compare_df.columns = ['å¹³å‡å€¼', 'ç¸½å’Œ', 'æœ€å¤§å€¼']

# é¡¯ç¤ºè¡¨æ ¼
st.dataframe(
    compare_df.style.format({
        'å¹³å‡å€¼': '{:.2f}',
        'ç¸½å’Œ': '{:.1f}',
        'æœ€å¤§å€¼': '{:.2f}'
    })
)
st.subheader("â˜€ï¸ 10 æœˆ vs 11 æœˆ å¤ªé™½èƒ½ç™¼é›»æ½›åŠ›æ¯”è¼ƒ")

solar_compare = (
    df[df['month'].isin([10, 11])]
    .groupby('month')['solar_kwh']
    .agg(['mean', 'sum'])
    .rename(index={10: '10 æœˆ', 11: '11 æœˆ'})
)

solar_compare.columns = ['å¹³å‡æ¯æ—¥ç™¼é›»é‡ (kWh)', 'æ•´æœˆç™¼é›»é‡ (kWh)']

st.dataframe(
    solar_compare.style.format({
        'å¹³å‡æ¯æ—¥ç™¼é›»é‡ (kWh)': '{:.2f}',
        'æ•´æœˆç™¼é›»é‡ (kWh)': '{:.1f}'
    })
)

st.subheader("ğŸ“Š 10 æœˆ vs 11 æœˆæ•´é«”æ¯”è¼ƒ")

fig2, ax = plt.subplots(figsize=(6, 4))

compare_df['å¹³å‡å€¼'].plot(kind='bar', ax=ax)
ax.set_ylabel(f"{col_name[primary]} ({unit[primary]})")
ax.set_title(f"10 æœˆ vs 11 æœˆ {col_name[primary]} å¹³å‡æ¯”è¼ƒ")
ax.grid(axis='y', alpha=0.3)

st.pyplot(fig2)

st.subheader("ğŸ“Š 10 æœˆ vs 11 æœˆ å¤ªé™½èƒ½ç™¼é›»æ½›åŠ›")

fig3, ax = plt.subplots(figsize=(6, 4))

solar_compare['å¹³å‡æ¯æ—¥ç™¼é›»é‡ (kWh)'].plot(kind='bar', ax=ax)
ax.set_ylabel("kWh / æ—¥")
ax.set_title("10 æœˆ vs 11 æœˆ å¹³å‡æ¯æ—¥å¤ªé™½èƒ½ç™¼é›»é‡")
ax.grid(axis='y', alpha=0.3)

st.pyplot(fig3)


